---
import ArticleCard from '../../components/article/ArticleCard.astro'
import Breadcrumb from '../../components/common/Breadcrumb.astro'
import Pagination from '../../components/common/Pagination.astro'
import BaseLayout from '../../layouts/BaseLayout.astro'
import { contentRepository } from '../../lib/repositories'

export async function getStaticPaths() {
  const tags = await contentRepository.getAllTags()

  const paths = []
  for (const tag of tags) {
    const posts = await contentRepository.getPostsByTag(tag.name)
    const POSTS_PER_PAGE = 10
    const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE)

    // 最初のページ
    paths.push({
      params: { tag: tag.name },
      props: {
        tag: tag.name,
        posts: posts.slice(0, POSTS_PER_PAGE),
        currentPage: 1,
        totalPages,
      },
    })

    // 2ページ目以降は別のルートで処理
  }

  return paths
}

const { tag, posts, currentPage, totalPages } = Astro.props
---

<BaseLayout
  title={`タグ: ${tag}`}
  description={`${tag}タグが付けられた記事の一覧`}
>
  <div class="max-w-5xl mx-auto">
    <!-- ヘッダー -->
    <div class="mb-8">
      <Breadcrumb
        items={[
          { label: 'ホーム', href: '/' },
          { label: 'タグ一覧', href: '/tags' },
          { label: tag }
        ]}
      />

      <h1 class="text-4xl font-bold mb-2">
        タグ: <span style="color: var(--color-accent)">{tag}</span>
      </h1>
      <p style="color: var(--color-text-sub)">
        {posts.length}件の記事が見つかりました
      </p>
    </div>

    <!-- 記事一覧 -->
    <div>
      {posts.map((post) => (
        <ArticleCard post={post} />
      ))}
    </div>

    {posts.length === 0 && (
      <div class="text-center py-12">
        <p style="color: var(--color-text-sub)">
          このタグの記事が見つかりませんでした。
        </p>
        <a
          href="/tags"
          class="inline-block mt-4 px-6 py-2 rounded-md transition-colors"
          style="background-color: var(--color-accent); color: white"
        >
          タグ一覧に戻る
        </a>
      </div>
    )}

    {totalPages > 1 && (
      <Pagination
        currentPage={currentPage}
        totalPages={totalPages}
        baseUrl={`/tags/${encodeURIComponent(tag)}`}
      />
    )}
  </div>
</BaseLayout>
